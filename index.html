<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Calidad Sede Villa â€“ OCR OV</title>
<meta name="theme-color" content="#0e141b"/>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png" type="image/png"/>
<style>
body{background:#0b1220;color:#eaf2ff;font-family:Arial;padding:10px}
button{padding:10px;background:#4cc9f0;border:none;border-radius:8px;margin:4px;font-weight:bold}
#results div{background:#101922;border:1px solid #1f2a37;padding:10px;border-radius:8px;margin-top:8px}
canvas{max-width:100%;background:#000;border-radius:10px;margin:8px 0}
</style>
</head>
<body>
<h2>OCR â€“ Calidad Sede Villa</h2>
<p>Solo extrae NÂ°, DescripciÃ³n y Cantidad.</p>

<input id="file" type="file" accept="image/*" capture="environment" style="display:none"/>
<button onclick="document.getElementById('file').click()">ðŸ“· Tomar foto</button>
<button id="btnProcess" disabled>ðŸ”Ž Procesar OCR</button>

<br><br>
<canvas id="canvas"></canvas>
<h3>Resultados:</h3>
<div id="results"></div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<script>
const file=document.getElementById('file');
const canvas=document.getElementById('canvas');
const ctx=canvas.getContext('2d');
const btnProcess=document.getElementById('btnProcess');
const resultsEl=document.getElementById('results');
let current=false;

file.addEventListener('change',()=>{
 const img=new Image();
 img.src=URL.createObjectURL(file.files[0]);
 img.onload=()=>{
  canvas.width=img.width;
  canvas.height=img.height;
  ctx.drawImage(img,0,0);
  current=true;
  btnProcess.disabled=false;
 };
});

btnProcess.addEventListener('click',async()=>{
 if(!current) return;
 resultsEl.innerHTML="Procesando...";
 const blob=await new Promise(res=>canvas.toBlob(res,'image/png'));
 const {data}=await Tesseract.recognize(blob,'spa',{logger:m=>{}});
 const items=parse(data.text);
 render(items);
});

function parse(text){
 const lines=text.split("\\n").map(s=>s.trim()).filter(Boolean);
 const out=[];
 for(const line of lines){
  const parts=line.match(/\\d+|[A-Za-zÃÃ‰ÃÃ“ÃšÃ‘ÃœÃ¡Ã©Ã­Ã³ÃºÃ±Ã¼â€™'Â°xX./\\-]+/g);
  if(!parts) continue;

  const nums=parts.filter(x=>/^\\d+$/.test(x));
  if(nums.length<2) continue;

  const num=parseInt(nums[0]);
  const cant=parseInt(nums[nums.length-1]);
  if(isNaN(num)||isNaN(cant)) continue;

  const first=parts.indexOf(nums[0]);
  const last=parts.lastIndexOf(nums[nums.length-1]);
  let desc=parts.slice(first+1,last).join(" ");

  desc=desc
   .replace(/^PRD\\d+/i,"")
   .replace(/(SACOS?|BLS|UND|CJ|KG)/gi,"")
   .replace(/[0-9]{2}\\.[0-9]{3}/g,"")
   .trim();

  if(desc.length<2) continue;
  out.push({num,desc,cant});
 }
 return out;
}

function render(data){
 resultsEl.innerHTML="";
 if(!data.length){resultsEl.innerHTML="Nada detectado";return;}
 data.forEach(i=>{
  const d=document.createElement('div');
  d.innerHTML=`<b>NÂ°:</b> ${i.num}<br><b>Desc:</b> ${i.desc}<br><b>Cant:</b> ${i.cant}`;
  resultsEl.appendChild(d);
 });
}
</script>
</body>
</html>
