<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Calidad Sede Villa ‚Äì Smart OCR v3.1 (2 columnas)</title>
<link rel="manifest" href="manifest.json">
<link rel="icon" href="icons/icon-192.png" type="image/png"/>
<meta name="theme-color" content="#0e141b"/>
<style>
  :root{
    --bg:#0b1220;--card:#101922;--line:#1f2a37;--ink:#eaf2ff;--muted:#a9b6c5;
    --brand:#4cc9f0;--ok:#22c55e;--err:#ef4444;--frame:#22c55e;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Inter}
  header{position:sticky;top:0;z-index:10;background:#0b1220cc;backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{margin:6px 0 2px;font-size:19px}
  .sub{color:var(--muted);font-size:13px;margin-bottom:8px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px;margin-top:12px}
  button{appearance:none;border:1px solid transparent;background:var(--brand);color:#071018;border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer;margin-right:8px}
  .ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
  .ok{background:var(--ok);color:#06140a}
  .danger{background:var(--err);color:white}
  input[type=file]{display:none}
  canvas.base{max-width:100%;border:1px solid var(--line);border-radius:12px;display:block}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .cols{display:grid;grid-template-columns:2fr 1fr;gap:10px}
  .chip{font-size:12px;color:var(--muted);background:#0b1118;border:1px solid var(--line);padding:6px 8px;border-radius:999px;display:inline-block}
  .list{display:grid;gap:10px}
  .item{background:#0b1118;border:1px solid var(--line);padding:10px;border-radius:12px}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#132235;border:1px solid var(--line)}
  .mini{font-size:12px;color:var(--muted)}
  .loader{display:none;align-items:center;gap:8px}
  .spin{width:16px;height:16px;border-radius:50%;border:2px solid #29425a;border-top-color:var(--brand);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .stage{position:relative;display:inline-block}
  .roi{position:absolute;border:3px dashed var(--frame);box-shadow:inset 0 0 0 2px rgba(34,197,94,.3);cursor:move}
  .handle{position:absolute;width:14px;height:14px;border-radius:50%;background:var(--frame);border:2px solid #064e3b}
  .h-nw{top:-8px;left:-8px} .h-ne{top:-8px;right:-8px} .h-sw{bottom:-8px;left:-8px} .h-se{bottom:-8px;right:-8px}
  .divider{position:absolute;top:0;bottom:0;width:3px;background:rgba(34,197,94,.85);cursor:ew-resize}
  .divider::after{content:'';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:32px;background:rgba(34,197,94,.85);border-radius:4px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>OCR ‚Äì √ìrdenes de Venta (Smart v3.1)</h1>
    <div class="sub">Marco verde ajustable manual/t√°ctil ‚Ä¢ Columnas: Descripci√≥n y Cantidad ‚Ä¢ OCR local (Tesseract.js)</div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div>
        <label class="ghost" for="file">üì∑ Tomar foto / Subir imagen</label>
        <input id="file" type="file" accept="image/*" capture="environment"/>
        <button id="btnCut" class="ghost" disabled>‚úÇÔ∏è Cortar seg√∫n marco</button>
        <button id="btnOCR" class="ghost" disabled>üîé OCR por columnas</button>
        <button id="btnClear" class="ghost">üóëÔ∏è Limpiar</button>
      </div>
      <div class="loader" id="loader"><span class="spin"></span><span>Procesando‚Ä¶</span></div>
    </div>

    <div class="grid" style="margin-top:12px">
      <div>
        <div class="chip">Vista previa + marco verde ajustable</div>
        <div class="stage">
          <canvas id="canvas" class="base"></canvas>
          <div id="roi" class="roi" hidden>
            <div class="handle h-nw"></div>
            <div class="handle h-ne"></div>
            <div class="handle h-sw"></div>
            <div class="handle h-se"></div>
            <div id="divider" class="divider" style="left:70%"></div>
          </div>
        </div>
        <div class="mini">Mueve y ajusta el marco verde para cubrir la tabla. La barra verde interna separa Descripci√≥n (izq.) y Cantidad (der.).</div>
      </div>
      <div>
        <div class="chip">Recortes</div>
        <div class="cols" style="margin-top:8px">
          <div>
            <div class="mini">Columna: Descripci√≥n</div>
            <canvas id="cDesc"></canvas>
          </div>
          <div>
            <div class="mini">Columna: Cantidad</div>
            <canvas id="cCant"></canvas>
          </div>
        </div>
        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <span id="colInfo" class="badge">‚Äì</span>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <div class="chip">Resultados extra√≠dos</div>
    <div id="tableWrap" style="margin-top:8px"></div>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
      <button id="btnExportJSON" class="ok" disabled>‚¨áÔ∏è Exportar JSON</button>
      <button id="btnExportCSV" class="ok" disabled>‚¨áÔ∏è Exportar CSV</button>
      <span id="count" class="badge">0 √≠tems</span>
    </div>
  </section>

  <p class="mini">Privacidad: todo se procesa <b>en tu navegador</b>. No se sube ninguna imagen.</p>
</main>

<script async src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<script>
const $ = (q)=>document.querySelector(q);
const file=$('#file'),canvas=$('#canvas'),ctx=canvas.getContext('2d');
const cDesc=$('#cDesc'),cCant=$('#cCant'),rDesc=cDesc.getContext('2d'),rCant=cCant.getContext('2d');
const btnCut=$('#btnCut'),btnOCR=$('#btnOCR'),btnClear=$('#btnClear');
const loader=$('#loader'),tableWrap=$('#tableWrap');
const btnExportJSON=$('#btnExportJSON'),btnExportCSV=$('#btnExportCSV');
const countBadge=$('#count'),roiEl=$('#roi'),divider=$('#divider'),colInfo=$('#colInfo');
let srcImage=null,extracted=[];

file.addEventListener('change',async()=>{
  if(!file.files?.length)return;
  const img=await loadImage(file.files[0]);
  drawBase(img);
  srcImage=img;
  initROI();
  btnCut.disabled=false;
  btnOCR.disabled=true;
  clearCols();
  setInfo('‚Äì');
});
btnClear.addEventListener('click',()=>{
  file.value='';ctx.clearRect(0,0,canvas.width,canvas.height);
  clearCols();tableWrap.innerHTML='';setCount(0);extracted=[];
  btnCut.disabled=true;btnOCR.disabled=true;setInfo('‚Äì');roiEl.hidden=true;
});
btnCut.addEventListener('click',()=>{
  if(!srcImage)return;
  const {rx,ry,rw,rh,splitX}=currentROI();
  cropToCanvas(canvas,cDesc,rx,ry,splitX-rx,rh);
  cropToCanvas(canvas,cCant,splitX,ry,rx+rw-splitX,rh);
  setInfo(`Desc: [${rx},${ry}]‚Üí${splitX-rx}px | Cant: [${splitX},${ry}]‚Üí${rx+rw-splitX}px`);
  btnOCR.disabled=!(cDesc.width&&cCant.width);
});
btnOCR.addEventListener('click',async()=>{
  if(btnOCR.disabled)return;toggleLoading(true);
  try{
    const[descTxt,qtyTxt]=await Promise.all([ocrCanvas(cDesc),ocrCanvas(cCant)]);
    const items=reconstructRows(descTxt,qtyTxt);
    renderTable(items);extracted=items;
    btnExportJSON.disabled=!items.length;btnExportCSV.disabled=!items.length;
    setCount(items.length);
  }catch(err){alert('Error en OCR: '+err.message);console.error(err);}
  finally{toggleLoading(false);}
});
btnExportJSON.addEventListener('click',()=>downloadFile('items.json',JSON.stringify(extracted,null,2),'application/json'));
btnExportCSV.addEventListener('click',()=>{
  const rows=[['descripcion','cantidad'],...extracted.map(r=>[csvEsc(r.descripcion),r.cantidad])];
  downloadFile('items.csv',rows.map(r=>r.join(',')).join('\\n'),'text/csv');
});
function loadImage(file){return new Promise((res,rej)=>{const i=new Image();i.onload=()=>res(i);i.onerror=rej;i.src=URL.createObjectURL(file);});}
function drawBase(img){const maxW=1500,scale=Math.min(1,maxW/img.naturalWidth);const W=Math.round(img.naturalWidth*scale),H=Math.round(img.naturalHeight*scale);canvas.width=W;canvas.height=H;ctx.drawImage(img,0,0,W,H);}
function cropToCanvas(srcCanvas,dstCanvas,sx,sy,sw,sh){dstCanvas.width=sw;dstCanvas.height=sh;dstCanvas.getContext('2d').drawImage(srcCanvas,sx,sy,sw,sh,0,0,sw,sh);}
function csvEsc(s){return /[\",\\n]/.test(s)?'\"'+s.replace(/\"/g,'\"\"')+'\"':s;}
function downloadFile(n,c,m){const b=new Blob([c],{type:m});const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=n;document.body.appendChild(a);a.click();a.remove();}
function toggleLoading(on){loader.style.display=on?'flex':'none';}
function clearCols(){[cDesc,cCant].forEach(c=>{c.width=0;c.height=0});}
function setInfo(s){colInfo.textContent=s;}
function setCount(n){countBadge.textContent=`${n} √≠tems`;}
async function ocrCanvas(cnv){const blob=await new Promise(r=>cnv.toBlob(r,'image/png'));const{data}=await Tesseract.recognize(blob,'spa',{logger:()=>{}});return data.text||'';}
function reconstructRows(descTxt,qtyTxt){const desc=splitClean(descTxt);const qtys=splitClean(qtyTxt).map(s=>parseInt((s.match(/\\d+/)||[''])[0])).filter(n=>Number.isInteger(n));const L=Math.min(desc.length,qtys.length);const out=[];for(let i=0;i<L;i++)out.push({descripcion:desc[i],cantidad:qtys[i]||''});return out;}
function splitClean(t){return t.replace(/\\r/g,'\\n').replace(/[|¬∑‚Ä¢]/g,' ').split('\\n').map(s=>s.trim()).filter(Boolean);}
function renderTable(items){tableWrap.innerHTML='';if(!items.length){tableWrap.innerHTML='<div class=\"item\">No se detectaron filas v√°lidas.</div>';return;}let html='<table style=\"width:100%;border-collapse:collapse\"><tr><th>Descripci√≥n</th><th>Cantidad</th></tr>';for(const r of items)html+=`<tr><td>${r.descripcion}</td><td>${r.cantidad}</td></tr>`;html+='</table>';tableWrap.innerHTML=html;}

// ====== ROI INTERACTIVO (MOUSE + TOUCH) ======
let drag=null;
function initROI(){roiEl.hidden=false;const W=canvas.width,H=canvas.height;const x=Math.round(W*0.1),y=Math.round(H*0.15);const w=Math.round(W*0.8),h=Math.round(H*0.7);roiEl.style.left=x+'px';roiEl.style.top=y+'px';roiEl.style.width=w+'px';roiEl.style.height=h+'px';divider.style.left=Math.round(w*0.7)+'px';}
function currentROI(){const rx=parseInt(roiEl.style.left),ry=parseInt(roiEl.style.top),rw=parseInt(roiEl.style.width),rh=parseInt(roiEl.style.height),splitOffset=parseInt(divider.style.left),splitX=rx+splitOffset;return{rx,ry,rw,rh,splitX};}
function pointerDown(x,y,e){const rect=roiEl.getBoundingClientRect();const localX=x-rect.left,localY=y-rect.top;const edge=12;if(localX<edge&&localY<edge)drag={type:'nw',ox:x,oy:y};else if(localX>rect.width-edge&&localY<edge)drag={type:'ne',ox:x,oy:y};else if(localX<edge&&localY>rect.height-edge)drag={type:'sw',ox:x,oy:y};else if(localX>rect.width-edge&&localY>rect.height-edge)drag={type:'se',ox:x,oy:y};else drag={type:'move',ox:x,oy:y};e.preventDefault();}
function pointerMove(x,y){if(!drag)return;const dx=x-drag.ox,dy=y-drag.oy;let X=parseInt(roiEl.style.left),Y=parseInt(roiEl.style.top),W=parseInt(roiEl.style.width),H=parseInt(roiEl.style.height);if(drag.type==='move'){X+=dx;Y+=dy;}else if(drag.type==='nw'){X+=dx;Y+=dy;W-=dx;H-=dy;}else if(drag.type==='ne'){Y+=dy;W+=dx;H-=dy;}else if(drag.type==='sw'){X+=dx;W-=dx;H+=dy;}else if(drag.type==='se'){W+=dx;H+=dy;}else if(drag.type==='divider'){let left=parseInt(divider.style.left)+dx;left=Math.max(20,Math.min(W-20,left));divider.style.left=left+'px';drag.ox=x;return;}roiEl.style.left=X+'px';roiEl.style.top=Y+'px';roiEl.style.width=Math.max(50,W)+'px';roiEl.style.height=Math.max(50,H)+'px';drag.ox=x;drag.oy=y;}
function pointerUp(){drag=null;}
roiEl.addEventListener('mousedown',e=>pointerDown(e.clientX,e.clientY,e));
divider.addEventListener('mousedown',e=>{drag={type:'divider',ox:e.clientX};e.stopPropagation();e.preventDefault();});
window.addEventListener('mousemove',e=>pointerMove(e.clientX,e.clientY));
window.addEventListener('mouseup',pointerUp);
roiEl.addEventListener('touchstart',e=>{const t=e.touches[0];pointerDown(t.clientX,t.clientY,e);});
divider.addEventListener('touchstart',e=>{const t=e.touches[0];drag={type:'divider',ox:t.clientX};e.stopPropagation();e.preventDefault();});
window.addEventListener('touchmove',e=>{const t=e.touches[0];pointerMove(t.clientX,t.clientY);});
window.addEventListener('touchend',pointerUp);
</script>
</body>
</html>
